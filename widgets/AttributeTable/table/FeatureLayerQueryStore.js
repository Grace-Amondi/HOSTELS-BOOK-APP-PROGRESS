// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array esri/tasks/query esri/tasks/QueryTask ./FeatureLayerQueryResult".split(" "),function(g,h,l,m,p,n){return g(null,{queryUrl:"",idProperty:"id",data:null,_entityData:null,constructor:function(b){g.safeMixin(this,b);this.data=[];this._entityData=[];this.layer=b.layer;this.objectIds=b.objectIds;this.where=b.where;this.orderByFields=b.orderByFields;this.totalCount=b.totalCount;this.batchCount=b.batchCount||25;this.idProperty=this.layer.objectIdField;
this.spatialFilter=b.spatialFilter;this.layer&&this.layer.url&&(this.queryTask=new p(this.layer.url))},get:function(b){return this.data[b]},getIdentity:function(b){return b[this.idProperty]},query:function(b,f){var d=new m,a=f&&f.start||0,k=this.batchCount,e=null;"function"===typeof b?e=b(this._entityData):"[object Array]"===Object.prototype.toString.call(b)&&(e=b);this.objectIds?(e=e?e:this.objectIds,d.objectIds=e.length>=a+this.batchCount?e.slice(a,a+k):e.slice(a)):(e&&0<e.length?d.objectIds=e.length>=
a+this.batchCount?e.slice(a,a+k):e.slice(a):(d.start=a,d.num=k,d.where=this.where,d.geometry=this.spatialFilter,d.spatialRelationship=m.SPATIAL_REL_INTERSECTS),(a=f.sort)&&0<a.length&&(a=l.map(a,function(a){return a.attribute+" "+(a.descending?"DESC":"ASC")}),d.orderByFields=a));d.returnGeometry="esriGeometryPoint"===this.layer.geometryType;d.outFields=["*"];var g=this.totalCount,a=null,a=!d.where;if(!(d.objectIds&&0<d.objectIds.length)&&a)return new n([]);a=this.queryTask?this.queryTask.execute(d):
this.layer.queryFeatures(d);a.total=a.then(h.hitch(this,function(a){var c=0,b=this.layer.objectIdField;if(this.objectIds){if(!b)for(c=0;c<a.fields.length;c++)if("esriFieldTypeOID"===a.fields[c].type){b=a.fields[c].name;break}for(var e={},c=0;c<a.features.length;c++)e[a.features[c].attributes[b]]=a.features[c];a.features=l.map(d.objectIds,function(a){return e[a]})}for(c=0;c<a.features.length;c++)if(a.features[c]){var f=a.features[c];a.features[c]=h.mixin(h.clone(f.attributes),{geometry:f.geometry});
this.data[a.features[c][b]]=a.features[c];this._entityData.push(a.features[c])}a=a.features;return g}),function(){console.log("FeatureLayerQueryStore queryFeatures failed.");return 0});return new n(a)}})});